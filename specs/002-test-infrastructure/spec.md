# Feature Specification: テストインフラストラクチャの導入

**Feature Branch**: `002-test-infrastructure`
**Created**: 2025-12-30
**Status**: Draft

## Overview

Estimate Poker Nextプロジェクトに、開発者がコード変更の影響を即座に確認できる包括的な自動テスト環境を導入します。これにより、バグの早期発見、リリース品質の向上、リファクタリングの安全性確保を実現します。

## Clarifications

### Session 2025-12-30

- Q: ネットワークエラーが発生した場合、E2Eテストはリトライするか適切にエラーを報告するか？ → A: テスト失敗時は即座に失敗として報告し、リトライしない（開発者が手動で再実行）
- Q: 並列実行時にテスト間で状態が共有されないか（データベースの競合など）？ → A: 各テストスイートが独立したデータベーススキーマまたはテーブル接頭辞を使用
- Q: カバレッジレポートが巨大になった場合、CI/CDパイプラインのパフォーマンスに影響しないか？ → A: カバレッジレポートをアーティファクトとして保存し、PRコメントにはサマリーのみ表示
- Q: テスト実行時のタイムアウト設定は適切か（長時間実行されるテストの扱い）？ → A: ユニットテストは30秒、E2Eテストは5分のタイムアウトを設定
- Q: モックデータが本番環境のデータ構造と乖離した場合、どのように検出するか？ → A: データベーススキーマのマイグレーションテストを含め、テストデータのセットアップ時にスキーマ整合性を検証

## User Scenarios & Testing

### User Story 1 - 開発者がコード変更の影響を即座に確認できる (Priority: P1)

開発者がコード変更をプッシュした際に、自動的にテストが実行され、影響範囲と潜在的な問題を即座に把握できる環境を提供します。これにより、バグの早期発見とリリース品質の向上を実現します。

**Why this priority**: プロジェクトの品質保証の基盤となる最重要機能。テスト自動化がなければ、他のすべての開発プロセスにリスクが伴います。

**Independent Test**: 開発者がコード変更をコミット・プッシュすると、CI/CD環境で自動的にコード品質チェック、型チェック、ユニットテストが実行され、結果がプルリクエストに表示されることで検証可能。

**Acceptance Scenarios**:

1. **Given** 開発者がコード変更をプッシュした、**When** CI/CD環境が起動する、**Then** コード品質チェック、型チェック、ユニットテストが順次実行され、結果がプルリクエストに表示される
2. **Given** テストが失敗した、**When** PRを確認する、**Then** 失敗したテストの詳細とカバレッジレポートが表示される
3. **Given** すべてのテストが成功した、**When** PRを確認する、**Then** グリーンチェックマークが表示され、マージ可能状態になる

---

### User Story 2 - ユーティリティ関数とコンポーネントの単体テスト (Priority: P2)

個別の関数やコンポーネントが仕様通りに動作することを検証できる環境を提供します。これにより、リファクタリングの安全性が向上し、技術的負債の蓄積を防ぎます。

**Why this priority**: コードベースの信頼性を確保し、将来の変更を安全に行うために必要。ただし、E2Eテストと比較すると、ユーザー価値への直接的な影響は小さい。

**Independent Test**: テストコマンドを実行すると、すべてのユニットテストが実行され、カバレッジレポートが生成されることで検証可能。

**Acceptance Scenarios**:

1. **Given** ユーティリティ関数が実装されている、**When** ユニットテストを実行する、**Then** 関数のすべての分岐パターンがテストされ、カバレッジが計測される
2. **Given** UIコンポーネントが実装されている、**When** コンポーネントテストを実行する、**Then** プロップスの変化に応じた描画が検証される
3. **Given** APIルートハンドラが実装されている、**When** APIテストを実行する、**Then** 正常系・異常系のレスポンスが検証される

---

### User Story 3 - クリティカルなユーザーフローのE2Eテスト (Priority: P3)

実際のユーザー操作を模倣した統合テストにより、システム全体が期待通りに動作することを検証します。これにより、リリース前に重大なバグを検出できます。

**Why this priority**: ユーザー体験の品質を保証する重要な機能ですが、ユニットテストや自動CI環境が整っていることが前提となります。

**Independent Test**: E2Eテストコマンドを実行すると、主要なユーザーフロー（ログイン→セッション作成→見積もり投票）が自動的にブラウザで実行され、すべてのステップが成功することで検証可能。

**Acceptance Scenarios**:

1. **Given** ゲストユーザーとしてログインページにアクセスした、**When** ニックネームを入力してセッションを作成し、見積もりを投票する、**Then** すべての操作が成功し、結果が正しく表示される
2. **Given** 認証ユーザーとしてログインした、**When** プロジェクトを作成し、セッションを開始する、**Then** プロジェクト配下のセッションが正しく表示される
3. **Given** セッションオーナーが見積もりを公開した、**When** 参加者が画面を確認する、**Then** 全員の見積もりと統計情報が表示される

---

### Edge Cases

- テスト失敗（ネットワークエラー含む）は即座に失敗として報告され、自動リトライは行わない。開発者が手動で再実行する
- 並列実行時は、各テストスイートが独立したデータベーススキーマまたはテーブル接頭辞を使用し、状態の共有を防ぐ
- カバレッジレポート全体はアーティファクトとして保存し、PRコメントには全体カバレッジ率と変更ファイルのカバレッジサマリーのみ表示
- ユニットテストは30秒、E2Eテストは5分のタイムアウトを設定し、超過したテストは失敗として扱う
- データベーススキーマのマイグレーションテストを含め、テストデータのセットアップ時にスキーマ整合性を検証し、構造の乖離を検出する

## Requirements

### Functional Requirements

- **FR-001**: システムは、ユーティリティ関数、UIコンポーネント、APIルートハンドラのユニットテストを実行できなければならない
- **FR-002**: システムは、テスト実行時にコードカバレッジを計測し、レポートを生成できなければならない
- **FR-003**: システムは、ゲストログイン、認証ログイン、セッション作成、見積もり投票の主要フローをE2Eテストで検証できなければならない
- **FR-004**: CI/CD環境は、プルリクエストごとにコード品質チェック、型チェック、ユニットテスト、E2Eテストを順次実行できなければならない
- **FR-005**: CI/CD環境は、テスト結果とカバレッジサマリー（全体カバレッジ率、変更ファイルのカバレッジ）をプルリクエスト内に表示し、詳細レポートはアーティファクトとして保存できなければならない
- **FR-006**: E2Eテストは、並列実行（シャーディング）をサポートし、実行時間を短縮できなければならない
- **FR-007**: APIテストは、認証が必要なエンドポイントに対して、適切な認証トークンを使用してテストできなければならない
- **FR-008**: テストは、モックデータベースまたはテスト専用データベースを使用し、本番データに影響を与えてはならない。並列実行時は各テストスイートが独立したスキーマまたはテーブル接頭辞を使用する
- **FR-009**: テスト失敗時には、詳細なエラーメッセージとスタックトレースが表示されなければならない
- **FR-010**: カバレッジレポートは、ファイル、関数、行、分岐の各レベルでカバレッジ率を表示できなければならない
- **FR-011**: データベーススキーマのマイグレーションテストを含め、テストデータのセットアップ時にスキーマ整合性を検証できなければならない

### Key Entities

- **テストスイート**: ユニットテスト、統合テスト、E2Eテストのグループ。各スイートは独立して実行可能
- **カバレッジレポート**: テスト実行後に生成される、コードのどの部分がテストされたかを示すレポート
- **CI/CDパイプライン**: コード変更時に自動実行される、テストとデプロイのワークフロー
- **テストデータ**: テスト実行時に使用されるモックユーザー、セッション、見積もりデータ

## Success Criteria

### Measurable Outcomes

- **SC-001**: コードカバレッジが60%以上に達する（ファイルベース）
- **SC-002**: コード変更のプッシュから10分以内にすべての自動テスト（コード品質チェック、型チェック、ユニット、E2E）が完了し、結果が可視化される
- **SC-003**: E2Eテストの並列実行により、単一実行と比較してテスト時間が50%以上短縮される
- **SC-004**: テスト失敗時、開発者が5分以内に失敗原因を特定できる（詳細なエラーメッセージとログが提供される）
- **SC-005**: カバレッジサマリー（全体カバレッジ率、変更ファイルのカバレッジ）がプルリクエスト内に自動的に表示され、詳細レポートがアーティファクトとしてアクセス可能である
- **SC-006**: 主要なユーザーフロー（ゲストログイン、セッション作成、見積もり投票）が100%E2Eテストでカバーされる

## Non-Functional Requirements

- **NFR-001**: テスト環境は、開発者のローカル環境とCI環境の両方で同じ方法で実行できなければならない
- **NFR-002**: E2Eテストは、ブラウザのヘッドレスモードで実行され、CI環境での実行が可能でなければならない
- **NFR-003**: テストデータは、各テスト実行前に自動的にセットアップされ、実行後にクリーンアップされなければならない
- **NFR-004**: カバレッジレポートは、HTMLおよびJSON形式で出力され、CI環境とローカル環境の両方で閲覧可能でなければならない
- **NFR-005**: テスト失敗時は自動リトライを行わず、即座に失敗として報告し、詳細なエラーログを提供しなければならない
- **NFR-006**: ユニットテストは30秒、E2Eテストは5分のタイムアウトを設定し、超過したテストは失敗として扱わなければならない
- **NFR-007**: テストデータのセットアップ時にデータベーススキーマ整合性を検証し、構造の乖離を早期に検出しなければならない

## Assumptions

- 選択したテストフレームワークは、既存のテストパターンと互換性がある
- E2Eテストは、主要なブラウザで動作するが、CI環境では単一のブラウザエンジンを使用する
- テスト実行時のデータベースは、本番環境から完全に分離される
- CI/CDプラットフォームの無料枠で、プルリクエストごとのテスト実行が可能である（実行時間の制約を考慮）
- E2Eテストは、ローカルサーバーを起動して実行されるため、外部APIへの依存はモック化される

## Out of Scope

- パフォーマンステスト（負荷テスト、ストレステスト）は今回の範囲外
- セキュリティテスト（脆弱性スキャン、ペネトレーションテスト）は今回の範囲外
- ビジュアルリグレッションテスト（スクリーンショット比較）は今回の範囲外
- モバイルブラウザでのE2Eテストは今回の範囲外
- テスト結果の長期的な分析ダッシュボードは今回の範囲外
