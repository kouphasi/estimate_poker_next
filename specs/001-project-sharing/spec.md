# Feature Specification: プロジェクト共有機能

**Feature Branch**: `001-project-sharing`
**Created**: 2025-12-28
**Status**: Draft
**Input**: ログインしているユーザー同士でプロジェクトを共有できるようにしたい

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 招待URL発行 (Priority: P1)

プロジェクトオーナーとして、自分のプロジェクトにチームメンバーを招待するための招待URLを発行したい。これにより、チームメンバーがプロジェクトに参加できるようになる。

**Why this priority**: 招待URLがなければ他のユーザーはプロジェクトに参加できないため、この機能が全ての起点となる。

**Independent Test**: プロジェクト詳細画面から「招待URLを発行」ボタンをクリックし、一意の招待URLが生成されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ログイン済みのプロジェクトオーナーがプロジェクト詳細画面にいる, **When** 「招待URLを発行」ボタンをクリック, **Then** 一意の招待URLが生成され画面に表示される
2. **Given** 招待URLが表示されている, **When** コピーボタンをクリック, **Then** 招待URLがクリップボードにコピーされる
3. **Given** 既に招待URLが発行済みのプロジェクト, **When** 「招待URLを発行」ボタンをクリック, **Then** 新しい招待URLが生成され、古いURLは無効化される

---

### User Story 2 - 参加申請 (Priority: P2)

ログインユーザーとして、受け取った招待URLからプロジェクトへの参加申請を行いたい。これにより、オーナーに参加意思を伝えることができる。

**Why this priority**: 招待URLがあっても、参加申請ができなければメンバー追加のフローが完結しない。

**Independent Test**: 招待URLにアクセスし、参加申請ボタンをクリックして申請が送信されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ログイン済みユーザーが招待URLにアクセス, **When** 参加申請ページが表示される, **Then** プロジェクト名と「参加を申請する」ボタンが表示される
2. **Given** 参加申請ページが表示されている, **When** 「参加を申請する」ボタンをクリック, **Then** 参加申請が送信され、「申請済み」と表示される
3. **Given** 既に参加申請済みのユーザー, **When** 同じ招待URLにアクセス, **Then** 「申請中です。オーナーの承認をお待ちください」と表示される
4. **Given** 未ログインユーザーが招待URLにアクセス, **When** ページが表示される, **Then** ログイン画面にリダイレクトされ、ログイン後に参加申請ページに戻る

---

### User Story 3 - 参加リクエスト管理 (Priority: P3)

プロジェクトオーナーとして、参加リクエストを確認し、承認または拒否したい。これにより、プロジェクトメンバーを適切に管理できる。

**Why this priority**: 参加申請を処理する機能がなければ、申請が溜まるだけで実際にメンバーを追加できない。

**Independent Test**: プロジェクト詳細画面から参加リクエスト一覧を確認し、承認・拒否操作を行える。

**Acceptance Scenarios**:

1. **Given** 参加リクエストがあるプロジェクト, **When** オーナーがプロジェクト詳細画面を開く, **Then** 「参加リクエスト（N件）」と表示される
2. **Given** 参加リクエスト一覧を表示, **When** 特定のリクエストの「承認」ボタンをクリック, **Then** そのユーザーがメンバーに追加され、リクエストが一覧から消える
3. **Given** 参加リクエスト一覧を表示, **When** 特定のリクエストの「拒否」ボタンをクリック, **Then** そのリクエストが削除される
4. **Given** 拒否されたユーザー, **When** 同じ招待URLから再度申請, **Then** 新規の参加申請として送信できる

---

### User Story 4 - 共有プロジェクトの表示 (Priority: P4)

プロジェクトメンバーとして、参加しているプロジェクトを自分のプロジェクト一覧に表示させたい。これにより、自分がオーナーのプロジェクトと参加しているプロジェクトを一元管理できる。

**Why this priority**: メンバーが追加されても、一覧に表示されなければ実用的でない。

**Independent Test**: メンバーとして参加したプロジェクトがマイページのプロジェクト一覧に表示される。

**Acceptance Scenarios**:

1. **Given** プロジェクトへの参加が承認されたユーザー, **When** マイページを開く, **Then** 「参加中のプロジェクト」セクションにそのプロジェクトが表示される
2. **Given** 参加中のプロジェクトが表示されている, **When** プロジェクトをクリック, **Then** プロジェクト詳細画面が開き、セッション一覧が表示される
3. **Given** 参加中のプロジェクト, **When** メンバーがセッションを作成, **Then** そのプロジェクト内に新しいセッションが作成される

---

### User Story 5 - メンバー管理 (Priority: P5)

プロジェクトオーナーとして、現在のメンバー一覧を確認し、必要に応じてメンバーを削除したい。これにより、プロジェクトのメンバー構成を維持・管理できる。

**Why this priority**: 基本的な共有フローが完成した後の管理機能として必要。

**Independent Test**: メンバー一覧を表示し、特定メンバーの削除操作を行える。

**Acceptance Scenarios**:

1. **Given** メンバーがいるプロジェクト, **When** オーナーがプロジェクト詳細画面の「メンバー」タブを開く, **Then** 現在のメンバー一覧が表示される
2. **Given** メンバー一覧を表示, **When** 特定メンバーの「削除」ボタンをクリック, **Then** 確認ダイアログが表示される
3. **Given** 削除確認ダイアログ, **When** 「削除する」をクリック, **Then** そのメンバーがプロジェクトから削除される
4. **Given** プロジェクトから削除されたユーザー, **When** マイページを開く, **Then** そのプロジェクトは「参加中のプロジェクト」に表示されない

---

### Edge Cases

- 招待URLが無効（削除または再発行済み）の場合、「この招待URLは無効です」とエラー表示
- 自分がオーナーのプロジェクトに自分で参加申請した場合、「このプロジェクトはあなたがオーナーです」と表示
- 既にメンバーとして参加済みのプロジェクトに参加申請した場合、「既にこのプロジェクトのメンバーです」と表示
- プロジェクトが削除された場合、関連する参加申請・メンバーシップも削除される
- オーナー自身をメンバーから削除しようとした場合、削除ボタンが非表示または無効化

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはプロジェクトオーナーに対して一意の招待URL生成機能を提供しなければならない
- **FR-002**: 招待URLは推測困難なランダムトークン（16文字以上）を使用しなければならない
- **FR-003**: 新しい招待URLを発行した場合、以前のURLは無効化されなければならない
- **FR-004**: ログインユーザーのみが参加申請を送信できなければならない
- **FR-005**: 未ログインユーザーが招待URLにアクセスした場合、ログイン後に参加申請ページにリダイレクトされなければならない
- **FR-006**: プロジェクトオーナーは参加リクエストを承認または拒否できなければならない
- **FR-007**: 承認されたユーザーはメンバーとしてプロジェクトにアクセスできなければならない
- **FR-008**: メンバーはマイページでオーナーのプロジェクトと参加中のプロジェクトを区別して表示できなければならない
- **FR-009**: メンバーは参加中のプロジェクト内でセッションを作成・参加できなければならない
- **FR-010**: プロジェクトオーナーはメンバーをプロジェクトから削除できなければならない
- **FR-011**: プロジェクト削除時、関連する参加申請とメンバーシップは自動削除されなければならない

### Key Entities

- **招待トークン（InviteToken）**: プロジェクトと1対1で紐づく招待用の一意トークン。発行日時、有効/無効状態を持つ
- **参加申請（JoinRequest）**: ユーザーからプロジェクトへの参加リクエスト。申請者、申請日時、ステータス（保留中/承認済み/拒否）を持つ
- **プロジェクトメンバー（ProjectMember）**: プロジェクトとユーザーの関係。メンバーの役割（オーナー/メンバー）、参加日時を持つ

## Clarifications

### Session 2025-12-28

- Q: 参加リクエストが届いた際、オーナーへの通知はどうしますか？ → A: 通知なし（画面にバッジ表示のみ）
- Q: メンバーが作成したセッションのオーナーは誰になりますか？ → A: セッション作成者がセッションオーナーになる
- Q: メンバー自身がプロジェクトから脱退できるようにしますか？ → A: オーナーによる削除のみ（メンバーは脱退不可）

## Assumptions

- 参加リクエスト発生時のオーナーへの通知は行わない（プロジェクト詳細画面のバッジ表示で確認）
- 招待URLの有効期限は設けない（オーナーが明示的に再発行するまで有効）
- 1プロジェクトにつき招待URLは1つのみ（複数同時発行はしない）
- 拒否されたユーザーも再度同じ招待URLから申請可能（ブラックリスト機能は含まない）
- メンバーはプロジェクト内のすべてのセッションにアクセス可能（細かい権限分けはしない）
- メンバーが作成したセッションは、作成者がセッションオーナーとなる（プロジェクトオーナーではない）
- メンバーの役割は「オーナー」と「メンバー」の2種類のみ（管理者権限の階層化は含まない）
- メンバー自身による脱退機能は提供しない（オーナーによる削除のみ）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: オーナーが招待URLを発行してからメンバーが参加完了するまで2分以内で完了できる
- **SC-002**: 参加申請の承認/拒否操作が1クリックで完了できる
- **SC-003**: メンバーが参加中のプロジェクトをマイページから3秒以内に見つけられる
- **SC-004**: 招待URLから参加申請ページへのアクセスが初回ユーザーでも迷わず完了できる（離脱率10%以下）
- **SC-005**: プロジェクト共有機能により、チームでの見積もりセッション作成数が従来比50%増加する
