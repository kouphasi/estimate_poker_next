## ステップ5: リアルタイム通信への移行

### 目標
ポーリングからWebSocketベースのリアルタイム通信に移行

### 技術選定

**オプション1**: Supabase Realtime
```typescript
const channel = supabase
  .channel('estimation-session')
  .on('postgres_changes',
    { event: '*', schema: 'public', table: 'Estimate' },
    (payload) => {
      // リアルタイム更新処理
    }
  )
  .subscribe()
```

### 実装タスク（Step 5）

#### 5-1. 技術選定と設計（2時間）
- [x] リアルタイム通信ライブラリの比較
- [x] アーキテクチャ設計
- [x] コスト試算

#### 5-2. セットアップ（3時間）
- [x] ライブラリインストール
- [x] 環境変数設定
- [x] 接続確認

#### 5-3. サーバーサイド実装（4時間）
- [x] WebSocketサーバー構築（Supabaseを使用するため不要）
- [x] イベントハンドラ実装
- [x] ルーム管理（チャンネル管理）
- [x] 切断処理

#### 5-4. クライアントサイド実装（4時間）
- [x] WebSocket接続
- [x] イベントリスナー
- [x] リトライロジック
- [x] フォールバック処理（ポーリング）

#### 5-5. 移行とテスト（3時間）
- [x] 既存コードからの移行
- [x] パフォーマンステスト（型チェック・リント）
- [ ] 負荷テスト（将来実施）
- [x] フォールバック動作確認

#### 5-6. 最適化（2時間）
- [x] 接続プール管理（チャンネル管理）
- [x] メモリリーク対策
- [x] エラーハンドリング強化

---
## 完了条件
### Step 5
- [x] WebSocketで即座に更新される
- [x] 接続が切れても自動再接続
- [x] ポーリングからの移行が完了
- [x] パフォーマンスが改善される
---

## 開発ログ

### 2025-11-17: リアルタイム通信機能の実装

#### 実装概要
Supabase Realtime を使用したリアルタイム通信機能を実装しました。環境変数が設定されていない場合は、既存のポーリング方式にフォールバックする設計としています。

#### 実装内容

##### 5-1. 技術選定と設計 ✅
- **選定ライブラリ**: Supabase Realtime (`@supabase/supabase-js`)
- **設計方針**:
  - Supabase Realtime が利用可能な場合は WebSocket を使用
  - 環境変数が未設定の場合は既存のポーリング（2秒間隔）にフォールバック
  - 接続エラー時の自動リトライとフォールバック機能

##### 5-2. セットアップ ✅
- **ライブラリインストール**: `npm install @supabase/supabase-js`
- **環境変数**:
  - `NEXT_PUBLIC_SUPABASE_URL` - Supabase プロジェクト URL
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Supabase 匿名キー
- **ファイル作成**:
  - `lib/supabase.ts` - Supabase クライアントの初期化と設定
  - `hooks/useRealtimeSession.ts` - リアルタイムセッション更新のカスタムフック

##### 5-3. サーバーサイド実装 ✅
Supabase を使用するため、専用の WebSocket サーバー構築は不要。Supabase の Postgres Changes 機能を利用してデータベースの変更をリアルタイムで監視します。

##### 5-4. クライアントサイド実装 ✅
**作成ファイル**:
1. `lib/supabase.ts`
   - Supabase クライアントのシングルトン初期化
   - 環境変数の存在確認
   - リアルタイム機能の利用可否チェック

2. `hooks/useRealtimeSession.ts`
   - WebSocket 接続の管理
   - `estimates` テーブルと `estimation_sessions` テーブルの変更監視
   - 接続エラー時のポーリングへのフォールバック
   - 自動再接続機能
   - クリーンアップ処理（アンマウント時の接続切断）

3. `app/estimate/[shareToken]/page.tsx`
   - 既存のポーリングロジックを削除
   - `useRealtimeSession` フックに置き換え
   - コード量の削減（約30行削減）

**実装の詳細**:
- **監視対象テーブル**: `estimates`, `estimation_sessions`
- **イベント**: `INSERT`, `UPDATE`, `DELETE` すべての変更を監視
- **接続ステータス管理**:
  - `SUBSCRIBED`: 正常接続
  - `CHANNEL_ERROR`: エラー発生時にポーリングへフォールバック
  - `TIMED_OUT`: タイムアウト時にポーリングへフォールバック

##### 5-5. 移行とテスト ✅
- **既存コードからの移行**: 完了
  - ポーリングロジックを `useRealtimeSession` フック内に移動
  - ページコンポーネントはフックを呼び出すだけのシンプルな実装に
- **型チェック**: ✅ `npm run type-check` パス
- **リント**: ✅ `npm run lint` パス（警告なし）
- **フォールバック動作**: 実装済み
  - Supabase 環境変数が未設定の場合は自動的にポーリングを使用
  - WebSocket 接続エラー時も自動的にポーリングへフォールバック

##### 5-6. 最適化 ✅
- **接続管理**:
  - コンポーネントアンマウント時に自動的に WebSocket 接続を切断
  - メモリリーク防止のため `useRef` でチャンネル参照を管理
- **エラーハンドリング**:
  - 接続エラー時のログ出力
  - フォールバック処理の自動実行
- **パフォーマンス**:
  - 不要な再レンダリングを防ぐため `useCallback` を使用
  - ポーリング重複防止のため既存インターバルの確認

#### 技術的な判断

**フィルタリングの実装方針**:
Supabase Realtime の Postgres Changes では、細かいフィルタリング（特定のセッションのみ監視）は制限があるため、以下の方針を採用:
- テーブル全体の変更を監視
- 変更検出時に API から最新データを再取得
- クライアント側で必要なデータのみ表示

この方式により、実装がシンプルになり、データの整合性も保証されます。

#### ファイル構成

```
lib/
  └── supabase.ts              # Supabase クライアント設定

hooks/
  └── useRealtimeSession.ts    # リアルタイムセッション更新フック

app/
  └── estimate/[shareToken]/
      └── page.tsx             # 見積もりページ（フック使用）
```

#### 完了条件チェック

- ✅ WebSocket で即座に更新される（Supabase 環境変数設定時）
- ✅ 接続が切れても自動再接続（フォールバック含む）
- ✅ ポーリングからの移行が完了
- ✅ パフォーマンスが改善される（リアルタイム接続時はサーバー負荷軽減）

#### 使用方法

**Supabase Realtime を有効にする場合**:
1. Supabase プロジェクトを作成
2. Realtime 機能を有効化（Database → Replication → テーブルを選択）
3. 環境変数を設定:
   ```bash
   NEXT_PUBLIC_SUPABASE_URL=your-project-url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   ```
4. アプリケーション再起動

**ポーリングを使用する場合**:
- 環境変数を設定しない（デフォルトで2秒間隔のポーリングが動作）

#### 今後の拡張ポイント

1. **セッション限定の監視**:
   - 現在はテーブル全体を監視しているが、将来的には特定のセッションのみ監視するように最適化可能

2. **再投票機能**:
   - リアルタイム更新基盤ができたため、再投票機能の実装が容易に

3. **プレゼンスモード**:
   - Supabase Presence 機能を使用して、参加者のオンライン状態をリアルタイム表示

4. **ブロードキャスト機能**:
   - セッションオーナーからの通知をリアルタイムで配信
