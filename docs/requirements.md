# プログラミング工数見積もりアプリケーション 要件定義書

## 1. 概要

プログラミング開発における工数見積もりを、プランニングポーカー形式で複数人で協力して行うWebアプリケーション。

### 主な機能
- プロジェクトとタスクの管理
- リアルタイムの見積もりセッション（カードゲーム風UI）
- 見積もり結果の確定と履歴管理
- ニックネームユーザーと認証ユーザーの両対応

---

## 2. システム構成

### 技術スタック
- **Frontend**: Next.js (App Router)
- **Database**: PostgreSQL (Supabase or Vercel Postgres推奨)
- **ORM**: Prisma
- **リアルタイム通信**: ポーリング（将来的にWebSocket対応検討）
- **UI**: Tailwind CSS + shadcn/ui

---

## 3. データ構造

### 階層構造
```
認証ユーザー
  └─ プロジェクト（複数）
      └─ タスク（複数）
          └─ 見積もりセッション/部屋（複数）
              └─ 個別見積もり（参加者ごと）
```

### 補足
- ニックネームユーザーは一時的な見積もりセッション（部屋）のみ作成可能
- プロジェクトの作成は認証ユーザーのみ
- 1つのタスクに対して複数の見積もりセッションを作成可能（再見積もり対応）

---

## 4. ユーザー種別と権限

### 4.1 ニックネームユーザー（ゲスト）
- **作成方法**: ニックネームのみで参加
- **権限**:
  - 一時的な見積もりセッション（部屋）の作成
  - 見積もりセッションへの参加と見積もり投稿
- **データ保持期間**: 一定期間後に自動削除
- **制約**:
  - プロジェクト/タスクの作成不可
  - 過去の見積もり履歴の参照不可
  - 同じニックネーム使用可能（重複許可）

### 4.2 認証ユーザー
- **作成方法**: メール等による認証登録
- **権限**:
  - プロジェクトの作成・管理
  - タスクの作成・管理
  - 見積もりセッションの作成・管理
  - 見積もりセッションへの参加
- **データ保持期間**: 永続的に保存
- **追加機能**:
  - 過去の見積もり履歴の参照
  - プロジェクト/タスクの削除

### 4.3 権限の詳細

#### プロジェクトオーナー（認証ユーザー）
- プロジェクトの削除
- タスクの作成・編集・削除
- プロジェクト全体の管理

#### セッションオーナー（部屋作成者）
- 見積もりセッションの管理
- カード公開/非公開の切り替え
- 最終工数の確定
- セッションの停止

#### セッション参加者
- 見積もりの投稿
- 見積もりの変更（提出後も可能）

---

## 5. 機能要件

### 5.1 プロジェクト管理

#### プロジェクト作成
- **実行者**: 認証ユーザーのみ
- **必要情報**:
  - プロジェクト名
  - プロジェクト説明（任意）

#### プロジェクト一覧
- 自分が作成したプロジェクトを一覧表示
- プロジェクト詳細への遷移

### 5.2 タスク管理

#### タスク作成
- **実行者**: プロジェクトオーナー
- **必要情報**:
  - タスク名
  - タスク説明
- **場所**: プロジェクト詳細画面から作成

#### タスク一覧
- プロジェクト内のタスク一覧表示
- 各タスクの確定工数表示
- タスク詳細/見積もりセッション作成への遷移

### 5.3 見積もりセッション（部屋）

#### セッション作成
- **実行者**:
  - 認証ユーザー（タスクに紐付け）
  - ニックネームユーザー（一時的な部屋のみ）
- **生成物**: 共有用URL（一意なトークン付き）

#### セッションへの参加
- **方法**: 共有URLにアクセス
- **参加時**: ニックネーム入力（認証ユーザーも含む）
- **制限**: 参加者数の上限なし
- **URL有効期限**: セッションオーナーが停止するまで有効

#### 見積もりフロー

##### 1. カード選択
- **UI**: ポーカー風のカードゲームインターフェース
- **選択肢**:
  - `1h` (1時間)
  - `2h` (2時間)
  - `4h` (4時間)
  - `8h` (8時間)
  - `1d` (1日)
  - `1.5d` (1.5日)
  - `2d` (2日)
  - `3d` (3日)
  - `自由記述` (カスタム日数入力)
- **カード変更**: 提出後も変更可能
- **自由記述**: 選択時に入力フォーム表示（単位は「日」固定）

##### 2. 見積もり状況の表示制御
- **制御者**: セッションオーナー
- **モード**:
  - **非公開モード**: 他の参加者の見積もり状況を非表示
  - **公開モード**: 全参加者の見積もりをリアルタイム表示
- **切り替え**: セッション中いつでも可能
- **推奨フロー**: 全員提出まで非公開 → 提出後一斉公開（プランニングポーカー方式）

##### 3. リアルタイム更新
- **実装方法**: ポーリング（2秒間隔推奨）
- **更新内容**:
  - 参加者の見積もり状況
  - 公開/非公開ステータス
  - 確定工数

##### 4. 工数確定
- **実行者**: セッションオーナーのみ
- **方法**: 専用の入力欄に確定工数を入力
- **表示**: 全参加者の見積もりとは別に表示
- **補助機能**: 平均値・中央値の自動計算表示（推奨）
- **確定後**: タスクに確定工数が記録される

##### 5. 再投票
- **初期仕様**: 不可
- **将来対応**: 検討

##### 6. セッション進行
- **全員提出待ち**: 不要（全員が選択しなくても進行可能）
- **セッション状態**:
  - 準備中（参加者募集）
  - 見積もり中（カード選択）
  - 確定済み（工数確定後）
  - アーカイブ（終了後）

### 5.4 プロジェクト見積もり

#### 実装方法（要確認）
以下のいずれかを選択：

**パターンA**: タスクの合計値を自動計算
- プロジェクト画面にタスクの確定工数合計を表示
- 見積もりセッション不要

**パターンB**: プロジェクトレベルのセッション作成
- プロジェクト全体に対して見積もりセッションを作成
- タスクと同様のフローで見積もり

> **決定事項**: 後日確認必要

---

## 6. データ保持とライフサイクル

### 6.1 ニックネームユーザー（ゲスト）のデータ
- **保持期間**: 作成から30日間（推奨）
- **削除対象**:
  - 一時的な見積もりセッション
  - ゲストユーザー情報
  - 関連する見積もりデータ

### 6.2 認証ユーザーのデータ
- **保持期間**: 永続的
- **保存対象**:
  - プロジェクト
  - タスク
  - 見積もりセッション
  - 見積もり履歴

### 6.3 見積もり履歴
- **認証ユーザー**: 全履歴を参照可能
- **ニックネームユーザー**: 履歴参照不可

### 6.4 ユーザー移行
- **現時点**: ニックネームユーザーから認証ユーザーへの移行は不可
- **将来対応**: 検討

---

## 7. 非機能要件

### 7.1 パフォーマンス
- ポーリング間隔: 2〜3秒
- ページ読み込み: 3秒以内

### 7.2 セキュリティ
- 共有URLはランダムトークン（推測困難）
- セッションオーナーの権限検証
- データ削除時の完全削除

### 7.3 UX
- カードゲーム風の直感的なUI
- レスポンシブデザイン（モバイル対応）
- リアルタイム性の視覚的フィードバック

---

## 8. 画面構成

### 8.1 認証ユーザー向け

```
トップページ (/)
  ↓
プロジェクト一覧 (/projects)
  ↓
プロジェクト詳細 (/projects/[id])
  - タスク一覧
  - 新規タスク作成ボタン
  ↓
タスク作成/編集 (/projects/[id]/tasks/new)
  ↓
見積もりセッション管理 (/tasks/[id])
  - セッション一覧
  - 新規セッション作成
  - 共有URL生成
  ↓
見積もり画面 (/estimate/[shareToken])
```

### 8.2 ニックネームユーザー向け

```
トップページ (/)
  ↓
一時的な部屋作成
  - ニックネーム入力
  - 部屋名入力（任意）
  ↓
見積もり画面（共有URL発行）
```

### 8.3 共通（見積もり画面）

**レイアウト**:
- 上部: タスク名・説明
- 中央: カード選択エリア（ポーカー風）
- 左サイド: 参加者一覧
- 右サイド: 見積もり結果エリア
- 下部: セッションオーナー専用の工数確定欄

**カード表示**:
```
┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐
│ 1h  │ │ 2h  │ │ 4h  │ │ 8h  │
└─────┘ └─────┘ └─────┘ └─────┘
┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐
│ 1d  │ │1.5d │ │ 2d  │ │ 3d  │
└─────┘ └─────┘ └─────┘ └─────┘
┌──────────┐
│ 自由記述 │
└──────────┘
```

---

## 9. API設計（案）

### 9.1 プロジェクト

```
POST   /api/projects              - プロジェクト作成
GET    /api/projects              - プロジェクト一覧取得
GET    /api/projects/[id]         - プロジェクト詳細取得
PATCH  /api/projects/[id]         - プロジェクト更新
DELETE /api/projects/[id]         - プロジェクト削除
```

### 9.2 タスク

```
POST   /api/projects/[id]/tasks   - タスク作成
GET    /api/projects/[id]/tasks   - タスク一覧取得
GET    /api/tasks/[id]            - タスク詳細取得
PATCH  /api/tasks/[id]            - タスク更新
DELETE /api/tasks/[id]            - タスク削除
```

### 9.3 見積もりセッション

```
POST   /api/tasks/[id]/sessions           - セッション作成（認証ユーザー）
POST   /api/sessions                      - 一時セッション作成（ゲスト）
GET    /api/sessions/[shareToken]         - セッション情報取得
PATCH  /api/sessions/[shareToken]/reveal  - 公開/非公開切り替え
POST   /api/sessions/[shareToken]/finalize - 工数確定
```

### 9.4 見積もり

```
POST   /api/sessions/[shareToken]/estimates        - 見積もり投稿
GET    /api/sessions/[shareToken]/estimates        - 見積もり一覧取得（ポーリング用）
PATCH  /api/sessions/[shareToken]/estimates/[id]   - 見積もり更新
```

---

## 10. データベーススキーマ（Prisma）

```prisma
// ユーザー
model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  nickname      String
  isGuest       Boolean   @default(true)
  createdAt     DateTime  @default(now())
  expiresAt     DateTime? // ゲストユーザーの有効期限

  projects      Project[]
  estimates     Estimate[]
}

// プロジェクト
model Project {
  id            String    @id @default(cuid())
  name          String
  description   String?
  ownerId       String
  owner         User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tasks         Task[]
}

// タスク
model Task {
  id            String    @id @default(cuid())
  name          String
  description   String?
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  finalEstimate Float?    // 確定工数（日数）
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions      EstimationSession[]
}

// 見積もりセッション（部屋）
model EstimationSession {
  id            String         @id @default(cuid())
  taskId        String?        // タスクに紐付かない一時セッションの場合はnull
  task          Task?          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  ownerId       String
  shareToken    String         @unique
  isRevealed    Boolean        @default(false)
  status        SessionStatus  @default(ACTIVE)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  expiresAt     DateTime?      // ゲストセッションの有効期限

  estimates     Estimate[]
}

enum SessionStatus {
  ACTIVE      // アクティブ
  FINALIZED   // 工数確定済み
  ARCHIVED    // アーカイブ
}

// 個別の見積もり
model Estimate {
  id            String            @id @default(cuid())
  sessionId     String
  session       EstimationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId        String
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  nickname      String            // セッション参加時のニックネーム
  value         Float             // 工数（日数）
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@unique([sessionId, userId])
}
```

---

## 11. 実装優先順位

### フェーズ1: MVP（最小viable product）
1. ニックネームユーザーでの一時セッション作成
2. 見積もり画面（カードUI）
3. ポーリングによるリアルタイム更新
4. 公開/非公開切り替え
5. 工数確定機能

### フェーズ2: 認証機能
1. ユーザー認証実装
2. プロジェクト管理
3. タスク管理
4. タスクに紐付いたセッション作成

### フェーズ3: 履歴・分析
1. 見積もり履歴の参照
2. 平均値・中央値の統計表示
3. 過去データの検索・フィルター

### フェーズ4: 機能拡張
1. WebSocketによるリアルタイム通信
2. 再投票機能
3. プロジェクトレベルの見積もり
4. ゲストユーザーから認証ユーザーへの移行

---

## 12. 未確定事項・検討事項

### 要確認
- [ ] プロジェクトレベルの見積もり方法（タスク合計 vs 独立セッション）
- [ ] ポーリング間隔の最適値（パフォーマンステスト後決定）
- [ ] ゲストデータの保持期間（30日 vs 60日 vs その他）
- [ ] 自由記述カードの入力範囲（上限値の設定）

### 将来検討
- [ ] WebSocketへの移行
- [ ] 再投票機能
- [ ] カスタムカード選択肢の設定
- [ ] チーム機能
- [ ] 通知機能（見積もり完了通知など）
- [ ] CSVエクスポート機能

---

## 13. 参考資料

### プランニングポーカーとは
- 開発チームで工数見積もりを行う手法
- 各メンバーが独立して見積もり、その後公開して議論
- バイアスを減らし、より正確な見積もりを目指す

### 類似サービス
- Planning Poker Online
- Scrum Poker
- Pointing Poker

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-11-05 | 1.0.0 | 初版作成 |
